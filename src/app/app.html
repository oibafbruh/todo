<div class="container">
  <header class="header">
    <h1><mat-icon>check_box</mat-icon> {{ title() }}</h1>
    <div class="header-stats">
      <div class="stat-item">
        <span class="stat-number">{{ todos().length }}</span>
        <span class="stat-label">Gesamt</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ offeneTodos() }}</span>
        <span class="stat-label">Offen</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ erledigteAnzahl() }}</span>
        <span class="stat-label">Erledigt</span>
      </div>
    </div>
  </header>

  <main class="main-content">
    <!-- Neue Aufgabe Card -->
    <div class="card neue-aufgabe-card">
      <div class="card-header">
        <h3>Neue Aufgabe erstellen</h3>
      </div>
      <div class="card-body">
          <mat-form-field appearance="outline" class="flex-2">
            <mat-label>Titel</mat-label>
            <input 
              matInput 
              [(ngModel)]="neuerTitel" required
              placeholder="z.B. ToDo App in Angular erstellen"
              (keyup.enter)="hinzufuegen()"
            />
          </mat-form-field>
                
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Beschreibung</mat-label>
          <textarea 
            matInput 
            [(ngModel)]="neueBeschreibung"
            placeholder="Beschreibung der Aufgabe (optional)"
            rows="3"
          ></textarea>
        </mat-form-field>
        <div class="row">
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Priorität</mat-label>
            <mat-select [(ngModel)]="neuePriority">
              <mat-option value="niedrig">Niedrig</mat-option>
              <mat-option value="mittel">Mittel</mat-option>
              <mat-option value="hoch">Hoch</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Enddatum</mat-label>
            <input matInput [matDatepicker]="picker" [(ngModel)]="neueendeAm" />
            <mat-hint>MM/DD/YYYY</mat-hint>
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>

        
        <div class="form-actions">
          <button mat-raised-button color="primary" (click)="hinzufuegen()">
            Aufgabe hinzufügen
          </button>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-group">
        <label class="filter-label">Status:</label>
        <mat-chip-listbox class="filter-chips">
          <mat-chip-option 
            [selected]="filterStatus() === 'alle'"
            (click)="setStatusFilter('alle')"
          >
            Alle ({{ todos().length }})
          </mat-chip-option>
          <mat-chip-option 
            [selected]="filterStatus() === 'offen'"
            (click)="setStatusFilter('offen')"
          >
            Offen ({{ offeneTodos() }})
          </mat-chip-option>
          <mat-chip-option 
            [selected]="filterStatus() === 'erledigt'"
            (click)="setStatusFilter('erledigt')"
          >
            Erledigt ({{ erledigteAnzahl() }})
          </mat-chip-option>
        </mat-chip-listbox>
      </div>

      <div class="filter-group">
        <label class="filter-label">Priorität:</label>
        <mat-chip-listbox class="filter-chips">
          <mat-chip-option 
            [selected]="filterPriority() === 'alle'"
            (click)="setPriorityFilter('alle')"
          >
            Alle
          </mat-chip-option>
          <mat-chip-option 
            class="chip-hoch"
            [selected]="filterPriority() === 'hoch'"
            (click)="setPriorityFilter('hoch')"
          >
            Hoch
          </mat-chip-option>
          <mat-chip-option 
            class="chip-mittel"
            [selected]="filterPriority() === 'mittel'"
            (click)="setPriorityFilter('mittel')"
          >
            Mittel
          </mat-chip-option>
          <mat-chip-option 
            class="chip-niedrig"
            [selected]="filterPriority() === 'niedrig'"
            (click)="setPriorityFilter('niedrig')"
          >
            Niedrig
          </mat-chip-option>
        </mat-chip-listbox>
      </div>
    </div>

    <!-- Aufgabenliste -->
    <div class="aufgaben-container">
      <div class="list-header">
        <h2>
          Aufgaben
          <span class="count-badge">{{ gefilterteTodos().length }}</span>
        </h2>
      </div>

      @if (gefilterteTodos().length === 0) {
        <div class="empty-state">
          <h3>Keine Aufgaben gefunden</h3>
          <p>
            @if (filterStatus() !== 'alle' || filterPriority() !== 'alle') {
              Keine Aufgaben entsprechen den ausgewählten Filtern
            } @else {
              Wenn du eine Aufgabe erstellst, kannst du sie hier sehen
            }
          </p>
        </div>
      }

      <div 
        cdkDropList
        [cdkDropListLockAxis]="'y'"
        [cdkDropListAutoScrollStep]="2"
        (cdkDropListDropped)="onTodoDrop($event)"
        class="todo-list"
      >
        @for (todo of gefilterteTodos(); track todo.id) {
          <div 
            cdkDrag
            class="card aufgaben-card" 
            [class.erledigt]="todo.erledigt"
            [ngClass]="getPriorityClass(todo.priority)">
          @if (bearbeitenId === todo.id) {
            <!-- Bearbeitungsmodus -->
            <div class="card-body">
              <div class="form-row">
                <mat-form-field appearance="outline" class="flex-2">
                  <mat-label>Titel</mat-label>
                  <input 
                    matInput 
                    [(ngModel)]="bearbeitenTitel"
                    (keyup.enter)="speichern()"
                  />
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="flex-1">
                  <mat-label>Priorität</mat-label>
                  <mat-select [(ngModel)]="bearbeitenPriority">
                    <mat-option value="niedrig">Niedrig</mat-option>
                    <mat-option value="mittel">Mittel</mat-option>
                    <mat-option value="hoch">Hoch</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Beschreibung</mat-label>
                <textarea 
                  matInput 
                  [(ngModel)]="bearbeitenBeschreibung"
                  rows="2"
                ></textarea>
              </mat-form-field>
              
              <div class="form-actions">
                <button mat-raised-button color="primary" (click)="speichern()">
                  Speichern
                </button>
                <button mat-button (click)="abbrechenBearbeiten()">
                  Abbrechen
                </button>
              </div>
            </div>
          } @else {
            <!-- Ansichtsmodus -->
            <div class="card-body">
              <div class="aufgabe-header">
                <button 
                  mat-icon-button 
                  cdkDragHandle
                  class="drag-handle"
                  title="Ziehen zum Neuordnen"
                >
                  <mat-icon>drag_indicator</mat-icon>
                </button>
                
                <mat-checkbox
                  [checked]="todo.erledigt"
                  (change)="toggleErledigt(todo.id)"
                  color="primary"
                  class="todo-checkbox"
                ></mat-checkbox>
                
                <div class="aufgabe-content">
                  <div class="aufgabe-title-row">
                    <h3 class="aufgabe-titel">{{ todo.id + " - " + todo.titel }}</h3>
                    <span class="priority-badge" [ngClass]="getPriorityClass(todo.priority)">
                      {{ getPriorityLabel(todo.priority) }}
                    </span>
                  </div>
                  @if (todo.beschreibung) {
                    <p class="aufgabe-beschreibung">{{ todo.beschreibung }}</p>
                  }
                  <div class="aufgabe-meta">
                    <mat-icon class="meta-icon">schedule</mat-icon>
                    <span>{{ todo.erstelltAm | date:'dd.MM.yyyy, HH:mm' }} Uhr</span>
                  </div>
                </div>
                
                <div class="aufgabe-actions">
                  <button 
                    mat-icon-button
                    (click)="startBearbeiten(todo)"
                    title="Bearbeiten"
                  >
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button 
                    mat-icon-button
                    color="warn"
                    (click)="loeschen(todo.id)"
                    title="Löschen"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          }
          </div>
        }
      </div>
    </div>
    </main>
  </div>

  <footer>
    <p>Fabio Bauer - Angular To Do App</p>
    <p><a href="mailto:fabio.bauer@verwaltungsmanagement.at">fabio.bauer@verwaltungsmanagement.at</a></p>
    <p>© 2025</p>
  </footer>

  <router-outlet />
