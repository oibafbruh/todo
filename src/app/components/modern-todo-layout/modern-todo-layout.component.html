<div class="modern-layout">
  <!-- Modern Toolbar -->
  <mat-toolbar class="modern-toolbar" color="primary">
    <div class="toolbar-content">
      <div class="toolbar-left">
        <mat-icon class="toolbar-icon">assignment</mat-icon>
        <span class="toolbar-title headline-medium">Todo Management</span>
      </div>
      
      <div class="toolbar-right">
        <button mat-icon-button 
                (click)="toggleFilters()"
                matTooltip="Filter umschalten"
                [class.active]="showFilters">
          <mat-icon>{{ showFilters ? 'filter_list_off' : 'filter_list' }}</mat-icon>
        </button>
        
        <button mat-icon-button 
                [matMenuTriggerFor]="sortMenu"
                matTooltip="Sortieren">
          <mat-icon>sort</mat-icon>
        </button>
        <mat-menu #sortMenu="matMenu">
          <button mat-menu-item (click)="setSort('erstelltAm', 'desc')">
            <mat-icon>schedule</mat-icon>
            <span>Neueste zuerst</span>
          </button>
          <button mat-menu-item (click)="setSort('endeAm', 'asc')">
            <mat-icon>event</mat-icon>
            <span>Fälligkeitsdatum</span>
          </button>
          <button mat-menu-item (click)="setSort('priority', 'desc')">
            <mat-icon>flag</mat-icon>
            <span>Priorität</span>
          </button>
          <button mat-menu-item (click)="setSort('titel', 'asc')">
            <mat-icon>title</mat-icon>
            <span>Alphabetisch</span>
          </button>
        </mat-menu>
      </div>
    </div>
  </mat-toolbar>

  <!-- Filter Panel -->
  <div class="filter-panel" [class.expanded]="showFilters">
    <div class="filter-content">
      <!-- Search -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Suche in Todos</mat-label>
        <input matInput 
               [(ngModel)]="currentFilter.search" 
               (input)="onSearchChange($event)"
               placeholder="Titel, Beschreibung oder ID...">
        <mat-icon matPrefix>search</mat-icon>
        <button mat-icon-button 
                matSuffix 
                *ngIf="currentFilter.search"
                (click)="clearSearch()"
                matTooltip="Suche löschen">
          <mat-icon>clear</mat-icon>
        </button>
      </mat-form-field>

      <!-- Status Filter Chips -->
      <div class="filter-chips">
        <mat-chip-set>
          <mat-chip 
            [class.selected]="currentFilter.status === 'alle'"
            (click)="setStatusFilter('alle')"
            matTooltip="Alle Todos anzeigen">
            <mat-icon matChipAvatar>list</mat-icon>
            Alle
          </mat-chip>
          <mat-chip 
            [class.selected]="currentFilter.status === 'offen'"
            (click)="setStatusFilter('offen')"
            matTooltip="Nur offene Todos">
            <mat-icon matChipAvatar>pending</mat-icon>
            Offen
          </mat-chip>
          <mat-chip 
            [class.selected]="currentFilter.status === 'erledigt'"
            (click)="setStatusFilter('erledigt')"
            matTooltip="Nur erledigte Todos">
            <mat-icon matChipAvatar>check_circle</mat-icon>
            Erledigt
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Priority Filter -->
      <mat-form-field appearance="outline" class="priority-field">
        <mat-label>Priorität</mat-label>
        <mat-select [(ngModel)]="currentFilter.priority" (selectionChange)="onFilterChange()">
          <mat-option value="alle">Alle Prioritäten</mat-option>
          <mat-option value="niedrig">Niedrig</mat-option>
          <mat-option value="mittel">Mittel</mat-option>
          <mat-option value="hoch">Hoch</mat-option>
        </mat-select>
        <mat-icon matPrefix>flag</mat-icon>
      </mat-form-field>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <button mat-stroked-button 
                (click)="clearAllFilters()"
                [disabled]="!hasActiveFilters()"
                class="clear-button">
          <mat-icon>clear_all</mat-icon>
          Filter zurücksetzen
        </button>
        
        <span class="results-count body-medium">
          {{ (filteredTodos$ | async)?.length || 0 }} von {{ (todos$ | async)?.length || 0 }} Todos
        </span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading$ | async" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="body-medium">Lade Todos...</p>
  </div>

  <!-- Todo Table -->
  <div *ngIf="!(isLoading$ | async)" class="table-container">
    <mat-card class="table-card">
      <mat-card-content>
        <!-- New Todo Section -->
        <div class="new-todo-section">
          <div class="new-todo-container" *ngIf="!isCreatingNew">
            <button mat-stroked-button (click)="startCreatingNew()" class="add-new-button">
              <mat-icon>add</mat-icon>
              Neues Todo hinzufügen
            </button>
          </div>
          
          <div class="new-todo-form" *ngIf="isCreatingNew">
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Titel</mat-label>
                <input matInput [(ngModel)]="newTodo.titel" placeholder="Titel eingeben">
              </mat-form-field>
              
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Priorität</mat-label>
                <mat-select [(ngModel)]="newTodo.priority">
                  <mat-option value="niedrig">Niedrig</mat-option>
                  <mat-option value="mittel">Mittel</mat-option>
                  <mat-option value="hoch">Hoch</mat-option>
                </mat-select>
              </mat-form-field>
              
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Fälligkeitsdatum</mat-label>
                <input matInput [matDatepicker]="picker" [(ngModel)]="newTodo.endeAm">
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>
            </div>
            
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>Beschreibung</mat-label>
                <textarea matInput [(ngModel)]="newTodo.beschreibung" placeholder="Beschreibung eingeben" rows="2"></textarea>
              </mat-form-field>
            </div>
            
            <div class="form-actions">
              <button mat-button (click)="cancelCreatingNew()">Abbrechen</button>
              <button mat-raised-button color="primary" (click)="saveNewTodo()" [disabled]="!isNewTodoValid()">
                <mat-icon>save</mat-icon>
                Speichern
              </button>
            </div>
          </div>
        </div>

        <table mat-table [dataSource]="(filteredTodos$ | async) || []" class="todo-table">
          
          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let todo">
              <mat-checkbox 
                [checked]="todo.erledigt"
                (change)="onToggle(todo.id)"
                [color]="'primary'">
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let todo">
              <span class="todo-id">#{{ todo.id }}</span>
            </td>
          </ng-container>

          <!-- Title Column -->
          <ng-container matColumnDef="titel">
            <th mat-header-cell *matHeaderCellDef>Titel</th>
            <td mat-cell *matCellDef="let todo">
              <div class="title-cell">
                <span class="title-text" [class.completed]="todo.erledigt">{{ todo.titel }}</span>
                <span *ngIf="isOverdue(todo)" class="overdue-indicator" matTooltip="Überfällig">
                  <mat-icon>warning</mat-icon>
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="beschreibung">
            <th mat-header-cell *matHeaderCellDef>Beschreibung</th>
            <td mat-cell *matCellDef="let todo">
              <span class="description-text" [class.completed]="todo.erledigt">
                {{ todo.beschreibung.length > 50 ? (todo.beschreibung | slice:0:50) + '...' : todo.beschreibung }}
              </span>
            </td>
          </ng-container>

          <!-- Priority Column -->
          <ng-container matColumnDef="priority">
            <th mat-header-cell *matHeaderCellDef>Priorität</th>
            <td mat-cell *matCellDef="let todo">
              <mat-chip class="priority-chip priority-{{ todo.priority }}">
                {{ getPriorityLabel(todo.priority) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Due Date Column -->
          <ng-container matColumnDef="endeAm">
            <th mat-header-cell *matHeaderCellDef>Fällig</th>
            <td mat-cell *matCellDef="let todo">
              <span class="due-date" [class.overdue]="isOverdue(todo)">
                {{ todo.endeAm | date:'dd.MM.yyyy HH:mm' }}
              </span>
            </td>
          </ng-container>

          <!-- Created Date Column -->
          <ng-container matColumnDef="erstelltAm">
            <th mat-header-cell *matHeaderCellDef>Erstellt</th>
            <td mat-cell *matCellDef="let todo">
              <span class="created-date">{{ todo.erstelltAm | date:'dd.MM.yyyy' }}</span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Aktionen</th>
            <td mat-cell *matCellDef="let todo">
              <button mat-icon-button [matMenuTriggerFor]="actionMenu" matTooltip="Aktionen">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #actionMenu="matMenu">
                <button mat-menu-item (click)="openEditDialog(todo)">
                  <mat-icon>edit</mat-icon>
                  <span>Bearbeiten</span>
                </button>
                <button mat-menu-item (click)="onDelete(todo.id)">
                  <mat-icon>delete</mat-icon>
                  <span>Löschen</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['status', 'id', 'titel', 'beschreibung', 'priority', 'endeAm', 'erstelltAm', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['status', 'id', 'titel', 'beschreibung', 'priority', 'endeAm', 'erstelltAm', 'actions']" 
              [class.completed-row]="row.erledigt"
              [class.overdue-row]="isOverdue(row)"></tr>
        </table>

        <!-- No Data State -->
        <div *ngIf="((filteredTodos$ | async)?.length || 0) === 0" class="no-data-state">
          <mat-icon class="no-data-icon">inbox</mat-icon>
          <h3 class="title-medium">Keine Todos gefunden</h3>
          <p class="body-medium">
            {{ hasActiveFilters() ? 'Versuchen Sie, Ihre Suchkriterien zu ändern.' : 'Erstellen Sie Ihr erstes Todo, um loszulegen.' }}
          </p>
          <button mat-raised-button 
                  color="primary" 
                  (click)="startCreatingNew()"
                  class="create-first-button">
            <mat-icon>add</mat-icon>
            Erstes Todo erstellen
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
