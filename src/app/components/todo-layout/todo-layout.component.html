<div class="modern-layout">
  <!-- TItel -->
  <mat-toolbar class="modern-toolbar" color="primary">
    <div class="toolbar-content">
      <div class="toolbar-left">
        <span class="toolbar-title headline-medium">Angular RxJS Todo App</span>
      </div>
    </div>
  </mat-toolbar>

  <!-- Filter-->
  <div class="filters-bar">
    <div class="filter-content">
      <!-- Suche -->
      <div class="filter-item filter-search">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Suche in Todos</mat-label>
          <input matInput 
                 [(ngModel)]="currentFilter.search" 
                 (input)="onSearchChange($event)"
                 placeholder="Titel, Beschreibung oder ID...">
          <mat-icon matPrefix>search</mat-icon>
          @if (currentFilter.search) {
            <button mat-icon-button 
                    matSuffix 
                    (click)="clearSearch()"
                    matTooltip="Suche löschen">
              <mat-icon>clear</mat-icon>
            </button>
          }
        </mat-form-field>
      </div>

      <!-- Status -->
      <div class="filter-item filter-status">
        <mat-form-field appearance="outline" class="status-field">
          <mat-label>Status</mat-label>
          <mat-select [(ngModel)]="currentFilter.status" (selectionChange)="onFilterChange()">
            <mat-option value="alle">Alle</mat-option>
            <mat-option value="offen">Offen</mat-option>
            <mat-option value="erledigt">Erledigt</mat-option>
          </mat-select>
          <mat-icon matPrefix>checklist</mat-icon>
        </mat-form-field>
      </div>

      <!-- Priority-->
      <div class="filter-item filter-priority">
        <mat-form-field appearance="outline" class="priority-field">
          <mat-label>Priorität</mat-label>
          <mat-select [(ngModel)]="currentFilter.priority" (selectionChange)="onFilterChange()">
            <mat-option value="alle">Alle</mat-option>
            <mat-option value="niedrig">Niedrig</mat-option>
            <mat-option value="mittel">Mittel</mat-option>
            <mat-option value="hoch">Hoch</mat-option>
          </mat-select>
          <mat-icon matPrefix>flag</mat-icon>
        </mat-form-field>
      </div>

      <!-- Sort By -->
      <div class="filter-item filter-sortby">
        <mat-form-field appearance="outline" class="sortby-field">
          <mat-label>Sortieren nach</mat-label>
          <mat-select [(ngModel)]="currentFilter.sortBy" (selectionChange)="onFilterChange()">
            <mat-option value="erstelltAm">Erstellt</mat-option>
            <mat-option value="endeAm">Fällig</mat-option>
            <mat-option value="priority">Priorität</mat-option>
            <mat-option value="titel">Titel</mat-option>
          </mat-select>
          <mat-icon matPrefix>sort</mat-icon>
        </mat-form-field>
      </div>

      <!-- Sort Order -->
      <div class="filter-item filter-sortorder">
        <mat-form-field appearance="outline" class="sortorder-field">
          <mat-label>Reihenfolge</mat-label>
          <mat-select [(ngModel)]="currentFilter.sortOrder" (selectionChange)="onFilterChange()">
            <mat-option value="asc">Aufsteigend</mat-option>
            <mat-option value="desc">Absteigend</mat-option>
          </mat-select>
          <mat-icon matPrefix>swap_vert</mat-icon>
        </mat-form-field>
      </div>

      <!-- Reset -->
      <div class="filter-item filter-actions">
        <button mat-stroked-button 
                (click)="clearAllFilters()"
                [disabled]="!hasActiveFilters()"
                class="clear-button">
          <mat-icon>clear_all</mat-icon>
          Zurücksetzen
        </button>
        
        <span class="counter">
          {{ (filteredTodos$ | async)?.length || 0 }} / {{ (todos$ | async)?.length || 0 }}
        </span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading$ | async) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p class="body-medium">Lade Todos...</p>
    </div>
  }

  <!-- Todo Table -->
  @if ((isLoading$ | async) === false) {
    <div class="table-container">
    <mat-card class="table-card">
      <mat-card-content>
        <!-- New Todo Section -->
        <div class="new-todo-section">
          @if (!isCreatingNew) {
            <div class="new-todo-container">
              <button mat-stroked-button (click)="startCreatingNew()" class="add-new-button">
                <mat-icon>add</mat-icon>
                Neues Todo hinzufügen
              </button>
            </div>
          }
          
          <!-- reactive form -->
          @if (isCreatingNew) {
            <form class="new-todo-form" [formGroup]="todoForm" (ngSubmit)="saveNewTodo()">
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Titel</mat-label>
                  <input matInput formControlName="titel" placeholder="Titel eingeben" maxlength="100">
                  <mat-icon matSuffix>title</mat-icon>

                  @if (todoForm.get('titel')?.hasError('required')) {
                    <mat-error>Titel ist erforderlich</mat-error>
                  }
                  @if (todoForm.get('titel')?.hasError('minlength')) {
                    <mat-error>Mindestens 3 Zeichen</mat-error>
                  }
                  @if (todoForm.get('titel')?.hasError('maxlength')) {
                    <mat-error>Maximal 100 Zeichen</mat-error>
                  }
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Priorität</mat-label>
                  <mat-select formControlName="priority">
                    <mat-option value="niedrig">Niedrig</mat-option>
                    <mat-option value="mittel">Mittel</mat-option>
                    <mat-option value="hoch">Hoch</mat-option>
                  </mat-select>
                  <mat-icon matSuffix>flag</mat-icon>

                  @if (todoForm.get('priority')?.hasError('required')) {
                    <mat-error>Priorität ist erforderlich</mat-error>
                  }
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Fälligkeitsdatum</mat-label>
                  <input matInput [matDatepicker]="picker" formControlName="endeAm" placeholder="Datum auswählen">
                  <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                  <mat-datepicker #picker></mat-datepicker>

                  @if (todoForm.get('endeAm')?.hasError('required')) {
                    <mat-error>Datum ist erforderlich</mat-error>
                  }
                  @if (todoForm.get('endeAm')?.hasError('futureDate')) {
                    <mat-error>Datum muss in der Zukunft liegen</mat-error>
                  }
                </mat-form-field>
              </div>
              
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>Beschreibung</mat-label>
                  <textarea matInput formControlName="beschreibung" placeholder="Beschreibung eingeben" rows="2" maxlength="500"></textarea>
                  <mat-icon matSuffix>description</mat-icon>

                  @if (todoForm.get('beschreibung')?.hasError('required')) {
                    <mat-error>Beschreibung ist erforderlich</mat-error>
                  }
                  @if (todoForm.get('beschreibung')?.hasError('minlength')) {
                    <mat-error>Mindestens 10 Zeichen</mat-error>
                  }
                  @if (todoForm.get('beschreibung')?.hasError('maxlength')) {
                    <mat-error>Maximal 500 Zeichen</mat-error>
                  }
                </mat-form-field>
              </div>
              
              <div class="form-actions">
                <button mat-button type="button" (click)="cancelCreatingNew()">Abbrechen</button>
                <button mat-raised-button color="primary" type="submit" [disabled]="todoForm.invalid">
                  <mat-icon>save</mat-icon>
                  Speichern
                </button>
              </div>
            </form>
          }
        </div>

        <table mat-table [dataSource]="(filteredTodos$ | async) || []" class="todo-table">
          
          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let todo">
              <mat-checkbox 
                [checked]="todo.erledigt"
                (change)="onToggle(todo.id)"
                [color]="'primary'">
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let todo">
              <span class="todo-id">{{ todo.id }}</span>
            </td>
          </ng-container>

          <!-- Title Column -->
          <ng-container matColumnDef="titel">
            <th mat-header-cell *matHeaderCellDef>Titel</th>
            <td mat-cell *matCellDef="let todo">
              <div class="title-cell">
                <span class="title-text" [class.completed]="todo.erledigt">{{ todo.titel }}</span>
                @if (isOverdue(todo)) {
                  <span class="overdue-indicator" matTooltip="Überfällig">
                    <mat-icon>warning</mat-icon>
                  </span>
                }
              </div>
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="beschreibung">
            <th mat-header-cell *matHeaderCellDef>Beschreibung</th>
            <td mat-cell *matCellDef="let todo">
              <span class="description-text" [class.completed]="todo.erledigt">
                {{ todo.beschreibung.length > 50 ? (todo.beschreibung | slice:0:50) + '...' : todo.beschreibung }}
              </span>
            </td>
          </ng-container>

          <!-- Priority Column -->
          <ng-container matColumnDef="priority">
            <th mat-header-cell *matHeaderCellDef>Priorität</th>
            <td mat-cell *matCellDef="let todo">
              <mat-chip class="priority-chip priority-{{ todo.priority }}">
                {{ getPriorityLabel(todo.priority) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Due Date Column -->
          <ng-container matColumnDef="endeAm">
            <th mat-header-cell *matHeaderCellDef>Fällig</th>
            <td mat-cell *matCellDef="let todo">
              <span class="due-date" [class.overdue]="isOverdue(todo)">
                {{ todo.endeAm | date:'dd.MM.yyyy HH:mm' }}
              </span>
            </td>
          </ng-container>

          <!-- Created Date Column -->
          <ng-container matColumnDef="erstelltAm">
            <th mat-header-cell *matHeaderCellDef>Erstellt</th>
            <td mat-cell *matCellDef="let todo">
              <span class="created-date">{{ todo.erstelltAm | date:'dd.MM.yyyy' }}</span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Aktionen</th>
            <td mat-cell *matCellDef="let todo; let i = index">
              <button mat-icon-button [matMenuTriggerFor]="actionMenu" matTooltip="Aktionen">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #actionMenu="matMenu">
                <button mat-menu-item (click)="openEditDialog(todo)">
                  <mat-icon>edit</mat-icon>
                  <span>Bearbeiten (ID: {{todo?.id}})</span>
                </button>
                <button mat-menu-item (click)="onDelete(todo.id)">
                  <mat-icon>delete</mat-icon>
                  <span>Löschen</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['status', 'id', 'titel', 'beschreibung', 'priority', 'endeAm', 'erstelltAm', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['status', 'id', 'titel', 'beschreibung', 'priority', 'endeAm', 'erstelltAm', 'actions']" 
              [class.completed-row]="row.erledigt"
              [class.overdue-row]="isOverdue(row)"></tr>
        </table>


        <!-- Paginator https://material.angular.dev/components/paginator/examples#paginator-configurable-->
      <mat-paginator 
        [length]="(todos$ | async)?.length || 0" 
        [pageSizeOptions]="[10, 20, 50]" 
        aria-label="Select Page">
      </mat-paginator>

        <!-- No Data State -->
        @if (((filteredTodos$ | async)?.length || 0) === 0) {
          <div class="no-data-state">
            <mat-icon class="no-data-icon">inbox</mat-icon>
            <h3 class="title-medium">Keine Todos gefunden</h3>
            <p class="body-medium">
              {{ hasActiveFilters() ? 'Versuchen Sie, Ihre Suchkriterien zu ändern.' : 'Erstellen Sie Ihr erstes Todo, um loszulegen.' }}
            </p>
            <button mat-raised-button 
                    color="primary" 
                    (click)="startCreatingNew()"
                    class="create-first-button">
              <mat-icon>add</mat-icon>
              Erstes Todo erstellen
            </button>
          </div>
        }
      </mat-card-content>
    </mat-card>
    </div>
  }
</div>
